<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - NIECOMM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .sidebar-link {
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
            padding: 10px 15px;
            color: #495057;
            text-decoration: none;
            display: flex;
            align-items: center;
        }
        .sidebar-link:hover {
            background-color: #e9ecef;
            color: #dc3545; /* Red for Admin */
        }
        .sidebar-link.active {
            background-color: #dc3545;
            color: white !important;
        }
        .section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .section.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-premium {
            background: white;
            border-radius: 16px;
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            transition: transform 0.2s;
        }
        .card-premium:hover {
            transform: translateY(-2px);
        }
        .escrow-card {
            background: linear-gradient(135deg, #fff3cd 0%, #fff8e1 100%);
            border: 1px solid #ffeeba;
        }
        /* Mobile Sidebar */
        /* Removed custom mobile sidebar in favor of Bootstrap Offcanvas */
    </style>
</head>
<body class="bg-light">
    
    <!-- Mobile Sidebar Offcanvas -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas">
        <div class="offcanvas-header bg-light border-bottom">
            <h5 class="offcanvas-title fw-bold">Admin Menu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-0">
            <div class="p-3 bg-light border-bottom mb-3">
                <div class="d-flex align-items-center">
                    <div class="bg-danger text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                        <span id="mobile-offcanvas-initials">A</span>
                    </div>
                    <div>
                        <h6 class="mb-0 fw-bold" id="mobile-offcanvas-username">Admin</h6>
                        <small class="text-muted">Platform Administrator</small>
                    </div>
                </div>
            </div>
            <ul class="nav flex-column gap-1 p-3">
                <li class="nav-item">
                    <a onclick="showSection('dashboard'); bootstrap.Offcanvas.getInstance(document.getElementById('sidebarOffcanvas')).hide()" class="nav-link sidebar-link active text-dark rounded px-3 py-2 mb-1" id="mobile-nav-dashboard">
                        <i class="fas fa-tachometer-alt me-3 text-primary"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a onclick="showSection('verifications'); bootstrap.Offcanvas.getInstance(document.getElementById('sidebarOffcanvas')).hide()" class="nav-link sidebar-link text-dark rounded px-3 py-2 mb-1" id="mobile-nav-verifications">
                        <i class="fas fa-user-check me-3 text-success"></i> Verifications
                        <span class="badge bg-danger rounded-pill ms-auto" id="mobile-nav-badge-verify" style="display:none">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a onclick="showSection('users'); bootstrap.Offcanvas.getInstance(document.getElementById('sidebarOffcanvas')).hide()" class="nav-link sidebar-link text-dark rounded px-3 py-2 mb-1" id="mobile-nav-users">
                        <i class="fas fa-users me-3 text-info"></i> Users & Vendors
                    </a>
                </li>
                <li class="nav-item">
                    <a onclick="showSection('orders'); bootstrap.Offcanvas.getInstance(document.getElementById('sidebarOffcanvas')).hide()" class="nav-link sidebar-link text-dark rounded px-3 py-2 mb-1" id="mobile-nav-orders">
                        <i class="fas fa-shopping-bag me-3 text-warning"></i> All Orders
                    </a>
                </li>
                <li class="nav-item">
                    <a onclick="showSection('escrow'); bootstrap.Offcanvas.getInstance(document.getElementById('sidebarOffcanvas')).hide()" class="nav-link sidebar-link text-dark rounded px-3 py-2 mb-1" id="mobile-nav-escrow">
                        <i class="fas fa-wallet me-3 text-secondary"></i> Escrow System
                    </a>
                </li>
                <li class="nav-item">
                    <a onclick="showSection('withdrawals'); bootstrap.Offcanvas.getInstance(document.getElementById('sidebarOffcanvas')).hide()" class="nav-link sidebar-link text-dark rounded px-3 py-2 mb-1" id="mobile-nav-withdrawals">
                        <i class="fas fa-money-bill-wave me-3 text-success"></i> Withdrawals
                        <span class="badge bg-warning text-dark rounded-pill ms-auto" id="mobile-nav-badge-withdraw" style="display:none">0</span>
                    </a>
                </li>
                <li class="nav-item mt-3 pt-3 border-top">
                    <a href="#" onclick="logout()" class="nav-link text-danger px-3 py-2">
                        <i class="fas fa-sign-out-alt me-3"></i> Logout
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 bg-white sidebar shadow-sm p-3 d-none d-md-block" id="sidebar" style="height: 100vh; position: sticky; top: 0; overflow-y: auto; z-index: 1000;">
                <div class="d-flex align-items-center justify-content-between mb-4 pb-3 border-bottom">
                    <div class="d-flex align-items-center">
                        <div class="bg-danger text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                            <span id="sidebar-initials">A</span>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold" id="sidebar-username">Admin</h6>
                            <small class="text-muted">Platform Administrator</small>
                        </div>
                    </div>
                    <button class="btn btn-link text-dark d-md-none" onclick="toggleSidebar()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <ul class="nav flex-column gap-2">
                    <li class="nav-item">
                        <a onclick="showSection('dashboard')" class="sidebar-link active" id="nav-dashboard">
                            <i class="fas fa-tachometer-alt me-3" style="width: 20px;"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a onclick="showSection('verifications')" class="sidebar-link" id="nav-verifications">
                            <i class="fas fa-user-check me-3" style="width: 20px;"></i> Verifications 
                            <span class="badge bg-danger rounded-pill ms-auto" id="nav-badge-verify" style="display:none">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a onclick="showSection('users')" class="sidebar-link" id="nav-users">
                            <i class="fas fa-users me-3" style="width: 20px;"></i> Users & Vendors
                        </a>
                    </li>
                    <li class="nav-item">
                        <a onclick="showSection('orders')" class="sidebar-link" id="nav-orders">
                            <i class="fas fa-shopping-bag me-3" style="width: 20px;"></i> All Orders
                        </a>
                    </li>
                    <li class="nav-item">
                        <a onclick="showSection('escrow')" class="sidebar-link" id="nav-escrow">
                            <i class="fas fa-wallet me-3" style="width: 20px;"></i> Escrow System
                        </a>
                    </li>
                    <li class="nav-item">
                        <a onclick="showSection('withdrawals')" class="sidebar-link" id="nav-withdrawals">
                            <i class="fas fa-money-bill-wave me-3" style="width: 20px;"></i> Withdrawals 
                            <span class="badge bg-warning text-dark rounded-pill ms-auto" id="nav-badge-withdraw" style="display:none">0</span>
                        </a>
                    </li>
                    <li class="nav-item mt-4">
                        <a href="#" onclick="logout()" class="sidebar-link text-danger">
                            <i class="fas fa-sign-out-alt me-3" style="width: 20px;"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 py-4 px-md-4">
                
                <!-- Mobile Header -->
                <div class="col-12 d-md-none mb-3">
                    <div class="bg-white p-3 rounded shadow-sm d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="bg-danger text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 0.8rem;">
                                <span id="mobile-header-initials">A</span>
                            </div>
                            <span class="fw-bold text-truncate" style="max-width: 150px;" id="mobile-header-username">Admin</span>
                        </div>
                        <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas">
                            <i class="fas fa-bars me-1"></i> Menu
                        </button>
                    </div>
                </div>

                <!-- SECTION: DASHBOARD -->
                <div id="section-dashboard" class="section active">
                    <h2 class="fw-bold mb-4">Platform Overview</h2>

                    <!-- Escrow Info Card -->
                    <div class="card-premium escrow-card p-4 mb-4">
                        <div class="d-flex align-items-start">
                            <div class="bg-warning bg-opacity-25 p-3 rounded-circle me-3">
                                <i class="fas fa-shield-alt text-warning fa-lg"></i>
                            </div>
                            <div>
                                <h5 class="fw-bold mb-1">Escrow Status</h5>
                                <p class="mb-0 text-dark opacity-75">Funds are held for 3 days to allow returns, then released after delivery confirmation.</p>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4 mb-4">
                        <div class="col-md-3">
                            <div class="card-premium p-4 h-100">
                                <p class="text-muted small mb-1">Total Users</p>
                                <h3 class="fw-bold mb-0" id="stat-users">0</h3>
                                <small class="text-primary">Registered Accounts</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card-premium p-4 h-100">
                                <p class="text-muted small mb-1">Total Vendors</p>
                                <h3 class="fw-bold mb-0" id="stat-vendors">0</h3>
                                <small class="text-success">Active Sellers</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card-premium p-4 h-100">
                                <p class="text-muted small mb-1">Total Orders</p>
                                <h3 class="fw-bold mb-0" id="stat-orders">0</h3>
                                <small class="text-muted">Platform-wide</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card-premium p-4 h-100 border-start border-4 border-primary">
                                <p class="text-muted small mb-1">Escrow Held</p>
                                <h3 class="fw-bold text-primary mb-0" id="stat-escrow">₦0.00</h3>
                                <small class="text-muted">Trust Funds</small>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning d-flex align-items-center shadow-sm border-0" role="alert" id="pending-alert" style="display:none !important">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <div>
                            You have <strong id="pending-count-alert">0</strong> pending vendor verifications.
                            <a href="#" onclick="showSection('verifications')" class="alert-link">Review now</a>.
                        </div>
                    </div>
                </div>

                <!-- SECTION: VERIFICATIONS -->
                <div id="section-verifications" class="section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="fw-bold mb-1">Vendor Verifications</h2>
                            <p class="text-muted mb-0">Review and approve new vendor applications.</p>
                        </div>
                    </div>

                    <div class="card-premium p-0 overflow-hidden border-0 shadow-sm">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Vendor Details</th>
                                        <th>Business Info</th>
                                        <th>Location</th>
                                        <th class="text-end pe-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="verifications-table">
                                    <!-- Populated via JS -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-verifications" class="text-center py-5 d-none">
                            <div class="mb-3 text-muted opacity-50">
                                <i class="fas fa-check-circle fa-3x"></i>
                            </div>
                            <h5 class="fw-bold text-muted">All Caught Up!</h5>
                            <p class="text-muted small">No pending verifications at the moment.</p>
                        </div>
                    </div>
                </div>

                <!-- SECTION: USERS & VENDORS -->
                <div id="section-users" class="section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="fw-bold mb-0">Users & Vendors</h2>
                        <div class="btn-group shadow-sm">
                            <button class="btn btn-outline-secondary active" onclick="loadUsers('all', this)">All</button>
                            <button class="btn btn-outline-secondary" onclick="loadUsers('vendor', this)">Vendors</button>
                            <button class="btn btn-outline-secondary" onclick="loadUsers('user', this)">Buyers</button>
                        </div>
                    </div>
                    <div class="card-premium p-0 overflow-hidden">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Username</th>
                                        <th>Role</th>
                                        <th>Email / Phone</th>
                                        <th>Status</th>
                                        <th>Joined</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table">
                                    <!-- Populated via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SECTION: ORDERS -->
                <div id="section-orders" class="section">
                    <h2 class="fw-bold mb-4">All Orders</h2>
                    
                    <div class="card-premium escrow-card p-3 mb-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle text-warning me-2"></i>
                            <small class="mb-0 fw-bold">Escrow Policy: Funds are released 3 days after delivery confirmation.</small>
                        </div>
                    </div>

                    <div class="card-premium p-0 overflow-hidden">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Order #</th>
                                        <th>Customer</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Payment</th>
                                        <th>Total</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-table">
                                    <!-- Populated via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SECTION: WITHDRAWALS -->
                <div id="section-withdrawals" class="section">
                    <h2 class="fw-bold mb-4">Withdrawal Requests</h2>
                    <div class="alert alert-info shadow-sm border-0">
                        <i class="fas fa-info-circle me-2"></i>
                        These are requests from vendors to withdraw their wallet balance. Please manually transfer the funds to the bank details below and then click "Mark Sent".
                    </div>
                    <div class="card-premium p-0 overflow-hidden">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Vendor</th>
                                        <th>Amount</th>
                                        <th>Bank Details</th>
                                        <th>Date</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="withdrawals-table">
                                    <!-- Populated via JS -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-withdrawals" class="text-center py-5 d-none">
                            <p class="text-muted">No pending withdrawal requests.</p>
                        </div>
                    </div>
                </div>

                <!-- SECTION: ESCROW -->
                <div id="section-escrow" class="section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="fw-bold mb-1">Escrow Management</h2>
                            <p class="text-muted mb-0">Monitor and release funds held in trust.</p>
                        </div>
                    </div>

                    <!-- Escrow Info Card -->
                    <div class="card-premium escrow-card p-4 mb-4">
                        <div class="d-flex align-items-start">
                            <div class="bg-warning bg-opacity-25 p-3 rounded-circle me-3">
                                <i class="fas fa-shield-alt text-warning fa-lg"></i>
                            </div>
                            <div>
                                <h5 class="fw-bold mb-1">Escrow Status</h5>
                                <p class="mb-0 text-dark opacity-75">Funds are held for 3 days to allow returns, then released after delivery confirmation.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-4">
                            <div class="card-premium h-100 p-4 border-start border-4 border-primary">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <p class="text-muted small mb-1">Total Held in Escrow</p>
                                        <h3 class="fw-bold mb-0 text-primary" id="held-total">₦0.00</h3>
                                        <small class="text-muted">Waiting for delivery/maturity</small>
                                    </div>
                                    <div class="bg-primary bg-opacity-10 p-3 rounded-circle">
                                        <i class="fas fa-lock text-primary fa-lg"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card-premium h-100 p-4 border-start border-4 border-warning">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <p class="text-muted small mb-1">In 3-Day Window</p>
                                        <h3 class="fw-bold mb-0" id="window-total">₦0.00</h3>
                                        <small class="text-muted" id="window-count">0 orders delivered recently</small>
                                    </div>
                                    <div class="bg-warning bg-opacity-10 p-3 rounded-circle">
                                        <i class="fas fa-hourglass-half text-warning fa-lg"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card-premium h-100 p-4 border-start border-4 border-success">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <p class="text-muted small mb-1">Ready for Payout</p>
                                        <h3 class="fw-bold mb-0 text-success" id="pending-total">₦0.00</h3>
                                        <small class="text-muted" id="pending-count">0 orders matured</small>
                                    </div>
                                    <div class="bg-success bg-opacity-10 p-3 rounded-circle">
                                        <i class="fas fa-check-circle text-success fa-lg"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions Section -->
                    <div class="row g-4">
                        <div class="col-md-12">
                            <div class="card-premium p-4">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <div>
                                        <h5 class="fw-bold mb-1">Escrow Settlement</h5>
                                        <p class="text-muted small mb-0">Release funds to vendors for orders delivered over 3 days ago.</p>
                                    </div>
                                    <button id="process-btn" class="btn btn-primary px-4 py-2 fw-bold shadow-sm rounded-pill" onclick="processEscrow()">
                                        <i class="fas fa-sync-alt me-2"></i> Run Settlement Batch
                                    </button>
                                </div>
                                
                                <div id="process-result" class="alert alert-info d-none rounded-3">
                                    <i class="fas fa-info-circle me-2"></i> <span id="process-msg"></span>
                                </div>

                                <hr>
                                
                                <h6 class="fw-bold mb-3">How it works</h6>
                                <div class="row text-center">
                                    <div class="col-md-4 position-relative">
                                        <div class="p-3">
                                            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                                <i class="fas fa-shopping-cart text-primary fa-lg"></i>
                                            </div>
                                            <h6 class="fw-bold">1. Buyer Pays</h6>
                                            <p class="small text-muted">Funds are held securely in the NIECOMM Escrow Account.</p>
                                        </div>
                                        <i class="fas fa-chevron-right position-absolute top-50 end-0 translate-middle-y text-muted d-none d-md-block"></i>
                                    </div>
                                    <div class="col-md-4 position-relative">
                                        <div class="p-3">
                                            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                                <i class="fas fa-truck text-warning fa-lg"></i>
                                            </div>
                                            <h6 class="fw-bold">2. Delivery + 3 Days</h6>
                                            <p class="small text-muted">Timer starts upon delivery. Buyer has 3 days to verify item.</p>
                                        </div>
                                        <i class="fas fa-chevron-right position-absolute top-50 end-0 translate-middle-y text-muted d-none d-md-block"></i>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="p-3">
                                            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                                <i class="fas fa-wallet text-success fa-lg"></i>
                                            </div>
                                            <h6 class="fw-bold">3. Vendor Paid</h6>
                                            <p class="small text-muted">Funds automatically released to Vendor Wallet if no complaints.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Check Admin
        const currentUser = JSON.parse(localStorage.getItem('user'));
        if (!currentUser || currentUser.role !== 'admin') {
            window.location.href = 'login.html';
        }

        document.addEventListener('DOMContentLoaded', () => {
            showSection('dashboard');
            loadStats();
            loadVerifications();
            loadWithdrawals();
            loadEscrowStats();
        });

        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            
            document.getElementById('section-' + sectionId).classList.add('active');
            document.getElementById('nav-' + sectionId).classList.add('active');
            
            if (sectionId === 'users') loadUsers('all');
            if (sectionId === 'orders') loadOrders();
            if (sectionId === 'escrow') loadEscrowStats();
            if (sectionId === 'withdrawals') loadWithdrawals();

            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.remove('show');
                document.querySelector('.sidebar-overlay').classList.remove('show');
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('show');
            document.querySelector('.sidebar-overlay').classList.toggle('show');
        }

        // --- DASHBOARD ---
        async function loadStats() {
            try {
                const res = await fetch('/api/admin/stats');
                const stats = await res.json();
                
                document.getElementById('stat-users').innerText = stats.users;
                document.getElementById('stat-vendors').innerText = stats.vendors;
                document.getElementById('stat-orders').innerText = stats.orders;
                document.getElementById('stat-escrow').innerText = '₦' + Number(stats.escrow_held || 0).toLocaleString();

                if(stats.pending_verifications > 0) {
                    document.getElementById('pending-alert').style.setProperty('display', 'flex', 'important');
                    document.getElementById('pending-count-alert').innerText = stats.pending_verifications;
                    
                    // Update Desktop Badge
                    const badge = document.getElementById('nav-badge-verify');
                    badge.innerText = stats.pending_verifications;
                    badge.style.display = 'inline-block';

                    // Update Mobile Badge
                    const mBadge = document.getElementById('mobile-nav-badge-verify');
                    if(mBadge) {
                        mBadge.innerText = stats.pending_verifications;
                        mBadge.style.display = 'inline-block';
                    }
                }
            } catch (err) {
                console.error(err);
            }
        }

        // --- VERIFICATIONS ---
        async function loadVerifications() {
            try {
                const res = await fetch('/api/admin/verifications');
                const users = await res.json();
                const tbody = document.getElementById('verifications-table');
                
                if (users.length === 0) {
                    document.getElementById('no-verifications').classList.remove('d-none');
                    return;
                }

                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td class="ps-4">
                            <div class="fw-bold">${u.name}</div>
                            <small class="text-muted">${u.email}</small>
                        </td>
                        <td>
                            <div>CAC: ${u.cac_number || 'N/A'}</div>
                            <div>Phone: ${u.phone}</div>
                        </td>
                        <td>${u.address || 'N/A'}</td>
                        <td>
                            <button onclick="verifyUser(${u.id}, 'approve')" class="btn btn-sm btn-success rounded-pill me-1"><i class="fas fa-check"></i> Approve</button>
                            <button onclick="verifyUser(${u.id}, 'reject')" class="btn btn-sm btn-outline-danger rounded-pill"><i class="fas fa-times"></i> Reject</button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error(err);
            }
        }

        async function verifyUser(id, action) {
            if(!confirm(`${action === 'approve' ? 'Approve' : 'Reject'} this vendor?`)) return;
            try {
                const res = await fetch('/api/admin/verify', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: id, action })
                });
                const data = await res.json();
                if(data.success) {
                    loadVerifications();
                    loadStats();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch(err) {
                console.error(err);
            }
        }

        // --- USERS ---
        async function loadUsers(filter, btn) {
            if(btn) {
                document.querySelectorAll('#section-users .btn-group .btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            try {
                const res = await fetch('/api/admin/users');
                let users = await res.json();
                if(filter !== 'all') {
                    users = users.filter(u => u.role === filter);
                }
                
                const tbody = document.getElementById('users-table');
                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td class="ps-4 fw-bold">${u.name}</td>
                        <td><span class="badge bg-${u.role === 'admin' ? 'danger' : (u.role === 'vendor' ? 'primary' : 'secondary')} rounded-pill px-3">${u.role}</span></td>
                        <td>
                            <div>${u.email}</div>
                            <small class="text-muted">${u.phone || ''}</small>
                        </td>
                        <td>${u.is_verified ? '<span class="text-success"><i class="fas fa-check-circle"></i> Verified</span>' : '<span class="text-muted">Unverified</span>'}</td>
                        <td>${new Date(u.created_at).toLocaleDateString()}</td>
                    </tr>
                `).join('');
            } catch(err) {
                console.error(err);
            }
        }

        // --- ORDERS ---
        async function loadOrders() {
            try {
                const res = await fetch('/api/admin/orders');
                const orders = await res.json();
                const tbody = document.getElementById('orders-table');
                
                tbody.innerHTML = orders.map(o => `
                    <tr>
                        <td class="ps-4 fw-bold">#${o.order_number}</td>
                        <td>${o.buyer_name}</td>
                        <td>${new Date(o.created_at).toLocaleDateString()}</td>
                        <td><span class="badge bg-${getStatusColor(o.status)} rounded-pill px-3">${o.status}</span></td>
                        <td>${getEscrowBadge(o)}</td>
                        <td>₦${Number(o.total_amount).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="alert('Order Details coming soon')">View</button>
                        </td>
                    </tr>
                `).join('');
            } catch(err) {
                console.error(err);
            }
        }

        function getStatusColor(status) {
            switch(status) {
                case 'pending': return 'warning text-dark';
                case 'shipped': return 'info text-dark';
                case 'delivered': return 'success';
                case 'cancelled': return 'danger';
                default: return 'secondary';
            }
        }

        function getEscrowBadge(o) {
            if (o.payment_status === 'paid') {
                return '<span class="badge bg-success bg-opacity-10 text-success rounded-pill px-3"><i class="fas fa-check-circle me-1"></i> Released</span>';
            } else if (o.status === 'delivered') {
                return '<span class="badge bg-warning bg-opacity-10 text-warning rounded-pill px-3"><i class="fas fa-clock me-1"></i> In 3-Day Window</span>';
            } else {
                 return '<span class="badge bg-secondary bg-opacity-10 text-secondary rounded-pill px-3"><i class="fas fa-lock me-1"></i> Held</span>';
            }
        }

        // --- ESCROW ---
        async function loadEscrowStats() {
            try {
                const res = await fetch('/api/admin/escrow-stats');
                const data = await res.json();
                
                document.getElementById('held-total').innerText = '₦' + Number(data.held_total).toLocaleString();
                document.getElementById('window-total').innerText = '₦' + Number(data.window_total).toLocaleString();
                document.getElementById('window-count').innerText = `${data.window_count} orders delivered recently`;
                document.getElementById('pending-total').innerText = '₦' + Number(data.pending_payout_total).toLocaleString();
                document.getElementById('pending-count').innerText = `${data.pending_payout_count} orders matured`;
            } catch (err) {
                console.error(err);
            }
        }

        async function processEscrow() {
            const btn = document.getElementById('process-btn');
            const resultBox = document.getElementById('process-result');
            const msgSpan = document.getElementById('process-msg');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processing...';

            try {
                const res = await fetch('/api/admin/process-escrow', { method: 'POST' });
                const data = await res.json();

                resultBox.classList.remove('d-none', 'alert-danger', 'alert-success', 'alert-info');
                if (data.processed > 0) {
                    resultBox.classList.add('alert-success');
                    msgSpan.innerText = `Successfully processed ${data.processed} payouts. Funds released to vendors.`;
                } else {
                    resultBox.classList.add('alert-info');
                    msgSpan.innerText = 'No eligible orders found for payout at this time.';
                }

                loadEscrowStats(); // Refresh stats
            } catch (err) {
                resultBox.classList.remove('d-none');
                resultBox.classList.add('alert-danger');
                msgSpan.innerText = 'Error processing payouts.';
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync-alt me-2"></i> Run Settlement Batch';
            }
        }

        // --- WITHDRAWALS ---
        async function loadWithdrawals() {
            try {
                const res = await fetch('/api/admin/withdrawals');
                const requests = await res.json();
                const tbody = document.getElementById('withdrawals-table');
                
                if (requests.length === 0) {
                    document.getElementById('no-withdrawals').classList.remove('d-none');
                    document.getElementById('nav-badge-withdraw').style.display = 'none';
                    const mBadge = document.getElementById('mobile-nav-badge-withdraw');
                    if(mBadge) mBadge.style.display = 'none';
                    return;
                }

                // Update Desktop Badge
                const badge = document.getElementById('nav-badge-withdraw');
                badge.innerText = requests.length;
                badge.style.display = 'inline-block';

                // Update Mobile Badge
                const mBadge = document.getElementById('mobile-nav-badge-withdraw');
                if(mBadge) {
                    mBadge.innerText = requests.length;
                    mBadge.style.display = 'inline-block';
                }

                tbody.innerHTML = requests.map(r => `
                    <tr>
                        <td class="ps-4 fw-bold">${r.vendor_name}</td>
                        <td>₦${Number(r.amount).toLocaleString()}</td>
                        <td>
                            <div class="small text-muted">${r.bank_name}</div>
                            <div class="fw-bold">${r.account_number}</div>
                            <div class="small">${r.account_name}</div>
                        </td>
                        <td>${new Date(r.created_at).toLocaleDateString()}</td>
                        <td>
                            <button onclick="processWithdrawal(${r.id}, 'approve')" class="btn btn-sm btn-success rounded-pill me-1"><i class="fas fa-check"></i> Mark Sent</button>
                            <button onclick="processWithdrawal(${r.id}, 'reject')" class="btn btn-sm btn-outline-danger rounded-pill"><i class="fas fa-times"></i> Refund</button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error(err);
            }
        }

        async function processWithdrawal(id, action) {
            if(!confirm(action === 'approve' ? 'Confirm you have manually sent the funds?' : 'Reject and refund to wallet?')) return;
            
            try {
                const res = await fetch(`/api/admin/withdrawals/${id}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action })
                });
                const data = await res.json();
                if(data.success) {
                    loadWithdrawals();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch(err) {
                console.error(err);
            }
        }
    </script>
</body>
</html>