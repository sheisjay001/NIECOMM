<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - NIECOMM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body data-theme="light">
    <div id="nav-placeholder"></div>

    <section class="py-5 bg-light">
        <div class="container">
            <h2 class="mb-4 fw-bold">Checkout</h2>
            
            <div class="row g-5">
                <!-- Left Column: Forms -->
                <div class="col-lg-8">
                    <div id="alert-box"></div>
                    
                    <!-- Contact Information -->
                    <div class="card shadow-sm border-0 rounded-4 mb-4">
                        <div class="card-body p-4">
                            <h5 class="fw-bold mb-3"><i class="fas fa-user text-primary me-2"></i>Contact Information</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="contact_name" required placeholder="John Doe">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Email Address</label>
                                    <input type="email" class="form-control" id="contact_email" required placeholder="john@example.com">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="contact_phone" required placeholder="08012345678">
                                </div>
                                <div class="col-md-6 d-flex align-items-end">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="create_account" checked>
                                        <label class="form-check-label" for="create_account">
                                            Create an account for me
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div id="login-prompt" class="mt-3 d-none">
                                <small class="text-muted">Already have an account? <a href="login.html">Log in</a> for faster checkout.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Shipping Address -->
                    <div class="card shadow-sm border-0 rounded-4 mb-4">
                        <div class="card-body p-4">
                            <h5 class="fw-bold mb-3"><i class="fas fa-map-marker-alt text-primary me-2"></i>Shipping Address</h5>
                            <textarea id="shipping_address" class="form-control" rows="3" required placeholder="Enter your full delivery address (Street, City, State)"></textarea>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="card shadow-sm border-0 rounded-4 mb-4">
                        <div class="card-body p-4">
                            <h5 class="fw-bold mb-3"><i class="fas fa-wallet text-primary me-2"></i>Payment Method</h5>
                            
                            <div class="payment-options">
                                <div class="form-check p-3 border rounded-3 mb-2 selected-method" id="method-card">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="pay_card" value="card" checked>
                                    <label class="form-check-label w-100 d-flex justify-content-between align-items-center" for="pay_card">
                                        <span>
                                            <span class="fw-bold d-block">Pay with Card</span>
                                            <small class="text-muted">Secure payment via Paystack/Flutterwave</small>
                                        </span>
                                        <span>
                                            <i class="fab fa-cc-visa fa-lg text-primary"></i>
                                            <i class="fab fa-cc-mastercard fa-lg text-danger"></i>
                                        </span>
                                    </label>
                                </div>

                                <div class="form-check p-3 border rounded-3" id="method-transfer">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="pay_transfer" value="transfer">
                                    <label class="form-check-label w-100 d-flex justify-content-between align-items-center" for="pay_transfer">
                                        <span>
                                            <span class="fw-bold d-block">Bank Transfer</span>
                                            <small class="text-muted">Direct transfer to NIECOMM Escrow Account</small>
                                        </span>
                                        <i class="fas fa-university fa-lg text-secondary"></i>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Order Summary -->
                <div class="col-lg-4">
                    <div class="card shadow-sm border-0 rounded-4 position-sticky" style="top: 100px;">
                        <div class="card-body p-4">
                            <h5 class="fw-bold mb-4">Order Summary</h5>
                            
                            <div id="order-items-list" class="mb-3" style="max-height: 300px; overflow-y: auto;">
                                <!-- Skeleton Loading -->
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="skeleton skeleton-rect rounded me-3" style="width: 50px; height: 50px;"></div>
                                        <div>
                                            <div class="skeleton skeleton-text mb-1" style="width: 100px;"></div>
                                            <div class="skeleton skeleton-text" style="width: 50px;"></div>
                                        </div>
                                    </div>
                                    <div class="skeleton skeleton-text" style="width: 60px;"></div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="skeleton skeleton-rect rounded me-3" style="width: 50px; height: 50px;"></div>
                                        <div>
                                            <div class="skeleton skeleton-text mb-1" style="width: 100px;"></div>
                                            <div class="skeleton skeleton-text" style="width: 50px;"></div>
                                        </div>
                                    </div>
                                    <div class="skeleton skeleton-text" style="width: 60px;"></div>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Subtotal</span>
                                <span class="fw-bold" id="subtotal">₦0.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Shipping</span>
                                <span class="text-success fw-bold">Free</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Escrow Fee</span>
                                <span class="text-success fw-bold">Waived</span>
                            </div>
                            
                            <hr>
                            
                            <div class="d-flex justify-content-between mb-4">
                                <span class="fw-bold fs-5">Total</span>
                                <span class="fw-bold fs-5 text-primary" id="total-amount">₦0.00</span>
                            </div>

                            <button id="place-order-btn" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow-sm">
                                <i class="fas fa-lock me-2"></i> Pay Now
                            </button>
                            
                            <div class="text-center mt-3">
                                <small class="text-muted"><i class="fas fa-shield-alt text-success me-1"></i> 100% Secure Escrow Payment</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

                    <!-- Bank Transfer Instructions Modal -->
                    <div class="modal fade" id="bankTransferModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content rounded-4 border-0">
                                <div class="modal-header border-0 pb-0">
                                    <h5 class="modal-title fw-bold">Bank Transfer Instructions</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body p-4">
                                    <div class="alert alert-info border-0 d-flex align-items-center mb-4">
                                        <i class="fas fa-info-circle fs-4 me-3"></i>
                                        <div>
                                            Please transfer the exact amount of <strong id="transfer-amount" class="text-primary"></strong> to the account below.
                                        </div>
                                    </div>
                                    
                                    <div class="bg-light p-4 rounded-3 mb-4 border text-center">
                                        <p class="text-muted small text-uppercase mb-1">Bank Name</p>
                                        <h5 class="fw-bold mb-3">Zenith Bank</h5>
                                        
                                        <p class="text-muted small text-uppercase mb-1">Account Number</p>
                                        <h3 class="fw-bold font-monospace text-primary mb-3">1010101010</h3>
                                        
                                        <p class="text-muted small text-uppercase mb-1">Account Name</p>
                                        <h5 class="fw-bold mb-0">NIECOMM ESCROW SERVICES</h5>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label small text-muted">Upload Proof of Payment (Optional)</label>
                                        <input type="file" class="form-control" id="proof-upload">
                                    </div>

                                    <button class="btn btn-primary w-100 py-3 rounded-pill fw-bold" onclick="confirmTransfer()">
                                        I have made the transfer
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Modal (Card) -->
                    <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Secure Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Card Payment Form -->
                    <div id="card-payment-form">
                        <div class="text-center mb-4">
                            <div class="display-6 fw-bold text-primary mb-1" id="modal-amount">₦0.00</div>
                            <small class="text-muted">NIECOMM Escrow Account</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small text-muted text-uppercase fw-bold">Card Number</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="fas fa-credit-card text-muted"></i></span>
                                <input type="text" class="form-control border-start-0 ps-0" placeholder="0000 0000 0000 0000" id="card-number">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label small text-muted text-uppercase fw-bold">Expiry</label>
                                <input type="text" class="form-control" placeholder="MM/YY" id="card-expiry">
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label small text-muted text-uppercase fw-bold">CVV</label>
                                <input type="password" class="form-control" placeholder="123" id="card-cvv">
                            </div>
                        </div>

                        <button class="btn btn-success w-100 py-3 rounded-3 fw-bold mt-2" onclick="processPayment()">
                            Pay <span id="pay-btn-amount"></span>
                        </button>
                    </div>

                    <!-- Processing State -->
                    <div id="payment-processing" class="text-center py-5 d-none">
                        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
                        <h5 class="fw-bold">Processing Payment...</h5>
                        <p class="text-muted">Please do not close this window.</p>
                    </div>

                    <!-- Success State -->
                    <div id="payment-success" class="text-center py-4 d-none">
                        <div class="mb-3">
                            <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                        </div>
                        <h4 class="fw-bold text-success">Payment Successful!</h4>
                        <p class="text-muted">Your funds are now held in Escrow.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadNav();
            // checkAuth(); // Allow guest checkout
            prefillContact();
            loadCartSummary();
        });

        function prefillContact() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (user) {
                document.getElementById('contact_name').value = user.username || '';
                document.getElementById('contact_email').value = user.email || '';
                document.getElementById('contact_phone').value = user.phone || ''; // Assuming phone exists
                // Make readonly or allow editing? Allow editing for shipping contact
                document.getElementById('contact_email').readOnly = true; 
                document.getElementById('create_account').closest('.col-md-6').style.display = 'none'; // Hide create account checkbox
            } else {
                document.getElementById('login-prompt').classList.remove('d-none');
            }
        }

        // Toggle Payment Method Styles
        document.querySelectorAll('input[name="paymentMethod"]').forEach(input => {
            input.addEventListener('change', (e) => {
                document.querySelectorAll('.payment-options .form-check').forEach(el => el.classList.remove('selected-method', 'border-primary', 'bg-light'));
                const parent = e.target.closest('.form-check');
                parent.classList.add('selected-method', 'border-primary', 'bg-light');
            });
        });

        function loadCartSummary() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            if (cart.length === 0) {
                window.location.href = 'products.html';
                return;
            }

            const itemsContainer = document.getElementById('order-items-list');
            let total = 0;

            itemsContainer.innerHTML = cart.map(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                return `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <img src="${item.image || 'https://via.placeholder.com/50'}" class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;">
                            <div>
                                <h6 class="mb-0 text-truncate" style="max-width: 150px;">${item.name}</h6>
                                <small class="text-muted">Qty: ${item.quantity}</small>
                            </div>
                        </div>
                        <span class="fw-bold">₦${itemTotal.toLocaleString()}</span>
                    </div>
                `;
            }).join('');

            document.getElementById('subtotal').innerText = `₦${total.toLocaleString()}`;
            document.getElementById('total-amount').innerText = `₦${total.toLocaleString()}`;
            document.getElementById('modal-amount').innerText = `₦${total.toLocaleString()}`;
            document.getElementById('pay-btn-amount').innerText = `₦${total.toLocaleString()}`;
            
            // Update Mobile Sticky Bar
            const mobileTotal = document.getElementById('mobile-total-amount');
            if(mobileTotal) mobileTotal.innerText = `₦${total.toLocaleString()}`;
        }

        const handlePlaceOrder = () => {
            // Validate Contact Info
            const name = document.getElementById('contact_name').value;
            const email = document.getElementById('contact_email').value;
            const phone = document.getElementById('contact_phone').value;
            
            if (!name || !email || !phone) {
                alert('Please fill in all contact information');
                document.getElementById('contact_name').focus();
                return;
            }

            const address = document.getElementById('shipping_address').value;
            if (!address) {
                alert('Please enter a shipping address');
                document.getElementById('shipping_address').focus();
                return;
            }
            
            // Store contact info in global object for submitOrder to access
            window.orderFormData = window.orderFormData || {};
            window.orderFormData.contact = { name, email, phone };
            window.orderFormData.shipping_address = address;
            
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            window.orderFormData.payment_method = paymentMethod;

            if (paymentMethod === 'transfer') {
                document.getElementById('transfer-amount').textContent = document.getElementById('total-amount').textContent;
                const modal = new bootstrap.Modal(document.getElementById('bankTransferModal'));
                modal.show();
            } else {
                // Show Card Payment Modal
                const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
                modal.show();
            }
        };

        document.getElementById('place-order-btn').addEventListener('click', handlePlaceOrder);
        
        // Mobile Sticky Button Listener
        const mobilePayBtn = document.getElementById('mobile-pay-btn');
        if(mobilePayBtn) {
            mobilePayBtn.addEventListener('click', handlePlaceOrder);
        }

        function confirmTransfer() {
            // Hide transfer modal
            const modalEl = document.getElementById('bankTransferModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            // Simulate processing
            const alertBox = document.getElementById('alert-box');
            alertBox.innerHTML = '<div class="alert alert-info">Verifying transfer details...</div>';
            
            setTimeout(() => {
                submitOrder();
            }, 1500);
        }

        function processPayment() {
            // Simulate Payment Processing
            document.getElementById('card-payment-form').classList.add('d-none');
            document.getElementById('payment-processing').classList.remove('d-none');

            setTimeout(() => {
                // Success
                document.getElementById('payment-processing').classList.add('d-none');
                document.getElementById('payment-success').classList.remove('d-none');
                
                // Submit Order after delay
                setTimeout(() => submitOrder(), 1500);
            }, 2000);
        }

        async function submitOrder() {
            // Get user if logged in
            const user = JSON.parse(localStorage.getItem('user'));
            // If not logged in, we rely on window.orderFormData which contains contact info
            
            const formData = new FormData();
            
            // Get data from window.orderFormData (preferred) or DOM (fallback)
            const orderData = window.orderFormData || {};
            // Address logic: orderData.shipping_address already contains name/phone if guest, but let's be safe.
            // Actually, handlePlaceOrder sets shipping_address to combined string.
            const address = orderData.shipping_address || document.getElementById('shipping_address').value;
            const paymentMethod = orderData.payment_method || document.querySelector('input[name="paymentMethod"]:checked').value;
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');

            if (user) {
                formData.append('user_id', user.id);
            } else if (orderData.contact) {
                // Guest Checkout
                formData.append('guest_info', JSON.stringify(orderData.contact));
            } else {
                // Should not happen if validation works
                alert('Please login or provide contact details');
                window.location.href = 'login.html';
                return;
            }

            formData.append('shipping_address', address);
            formData.append('cart', JSON.stringify(cart));
            formData.append('payment_method', paymentMethod);
            const alertBox = document.getElementById('alert-box');

            // Append proof of payment if exists and method is transfer
            if (paymentMethod === 'transfer') {
                const fileInput = document.getElementById('proof-upload');
                if (fileInput && fileInput.files.length > 0) {
                    formData.append('proof_of_payment', fileInput.files[0]);
                }
            }

            try {
                const res = await fetch('/api/orders', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    // Close any open modals
                    const paymentModalEl = document.getElementById('paymentModal');
                    if (paymentModalEl) {
                        const paymentModal = bootstrap.Modal.getInstance(paymentModalEl);
                        if (paymentModal) paymentModal.hide();
                    }
                    
                    const transferModalEl = document.getElementById('bankTransferModal');
                    if (transferModalEl) {
                        const transferModal = bootstrap.Modal.getInstance(transferModalEl);
                        if (transferModal) transferModal.hide();
                    }

                    localStorage.removeItem('cart');
                    updateCartCount();
                    
                    // Success Message
                    if (data.redirect) {
                        // If guest account created, maybe redirect to login or dashboard with token?
                        // For now, simple alert
                        alert(data.message);
                        window.location.href = data.redirect; // e.g., 'login.html' or 'user_dashboard.html'
                    } else {
                        alert('Order placed successfully! ' + (user ? 'Redirecting to dashboard...' : 'Check your email for details.'));
                        window.location.href = user ? 'user_dashboard.html' : 'products.html';
                    }
                } else {
                    alertBox.innerHTML = `<div class="alert alert-danger">${data.error || 'Failed to place order'}</div>`;
                }
            } catch (err) {
                console.error(err);
                alertBox.innerHTML = '<div class="alert alert-danger">An error occurred.</div>';
            }
        }
    </script>
</body>
</html>