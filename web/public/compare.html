<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compare Products - NIECOMM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .compare-table th {
            width: 200px;
            background-color: #f8f9fa;
            vertical-align: middle;
        }
        .compare-table td {
            min-width: 250px;
            vertical-align: top;
        }
        .product-img-large {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background-color: #fff;
        }
    </style>
</head>
<body data-theme="light">
    <!-- Navigation -->
    <div id="nav-placeholder"></div>

    <div class="container py-5">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                <li class="breadcrumb-item"><a href="products.html">Products</a></li>
                <li class="breadcrumb-item active" aria-current="page">Compare</li>
            </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">Product Comparison</h2>
            <button class="btn btn-outline-danger btn-sm" onclick="clearAll()">Clear All</button>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered compare-table shadow-sm bg-white">
                <tbody id="compare-body">
                    <!-- Loading Skeleton -->
                    <tr>
                        <th>Product</th>
                        <td>
                            <div class="skeleton skeleton-rect w-100 mb-2" style="height: 200px;"></div>
                            <div class="skeleton skeleton-text w-75 mb-2"></div>
                            <div class="skeleton skeleton-text w-50"></div>
                        </td>
                        <td>
                            <div class="skeleton skeleton-rect w-100 mb-2" style="height: 200px;"></div>
                            <div class="skeleton skeleton-text w-75 mb-2"></div>
                            <div class="skeleton skeleton-text w-50"></div>
                        </td>
                        <td>
                            <div class="skeleton skeleton-rect w-100 mb-2" style="height: 200px;"></div>
                            <div class="skeleton skeleton-text w-75 mb-2"></div>
                            <div class="skeleton skeleton-text w-50"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="empty-state" class="text-center py-5 d-none">
            <i class="fas fa-balance-scale fa-3x text-muted mb-3"></i>
            <h3>No products to compare</h3>
            <p class="text-muted">Select products from the marketplace to compare them side by side.</p>
            <a href="products.html" class="btn btn-primary mt-2">Browse Products</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadNav();
            loadComparison();
        });

        async function loadComparison() {
            const compareList = JSON.parse(localStorage.getItem('compareList')) || [];
            const tbody = document.getElementById('compare-body');
            const emptyState = document.getElementById('empty-state');
            const table = document.querySelector('.table-responsive');

            if (compareList.length === 0) {
                table.classList.add('d-none');
                emptyState.classList.remove('d-none');
                return;
            }

            try {
                const res = await fetch(`/api/products?ids=${compareList.join(',')}`);
                const products = await res.json();

                // Sort products to match the order in compareList (optional, but good for UX)
                const sortedProducts = compareList.map(id => products.find(p => p.id == id)).filter(p => p);

                if (sortedProducts.length === 0) {
                    table.classList.add('d-none');
                    emptyState.classList.remove('d-none');
                    return;
                }

                let html = '';

                // Row 1: Image, Name, Price
                html += '<tr><th>Product</th>';
                sortedProducts.forEach(p => {
                    html += `
                        <td class="text-center">
                            <img src="${p.image ? '/uploads/products/' + p.image : 'https://via.placeholder.com/300'}" class="product-img-large rounded mb-3" alt="${p.name}">
                            <h5 class="fw-bold"><a href="product_details.html?id=${p.id}" class="text-decoration-none text-dark">${p.name}</a></h5>
                            <h4 class="text-primary fw-bold">â‚¦${Number(p.price).toLocaleString()}</h4>
                        </td>
                    `;
                });
                html += '</tr>';

                // Row 2: Vendor
                html += '<tr><th>Vendor</th>';
                sortedProducts.forEach(p => {
                    html += `
                        <td>
                            <div class="d-flex align-items-center mb-1">
                                <span class="fw-bold me-2">${p.vendor_name}</span>
                                ${p.is_verified ? '<i class="fas fa-check-circle text-primary" title="Verified Vendor"></i>' : ''}
                            </div>
                            <div class="small text-muted"><i class="fas fa-map-marker-alt text-danger me-1"></i> ${p.state_name || 'N/A'}, ${p.city_name || ''}</div>
                        </td>
                    `;
                });
                html += '</tr>';

                // Row 3: Description (Truncated)
                html += '<tr><th>Description</th>';
                sortedProducts.forEach(p => {
                    const desc = p.description.length > 150 ? p.description.substring(0, 150) + '...' : p.description;
                    html += `<td>${desc}</td>`;
                });
                html += '</tr>';

                // Row 4: Category
                html += '<tr><th>Category</th>';
                sortedProducts.forEach(p => {
                    html += `<td><span class="badge bg-secondary">${p.category_name || 'Uncategorized'}</span></td>`;
                });
                html += '</tr>';

                // Row 5: Actions
                html += '<tr><th>Actions</th>';
                sortedProducts.forEach(p => {
                    html += `
                        <td class="text-center">
                            <button class="btn btn-premium-primary w-100 mb-2" onclick="addToCart(${p.id})">Add to Cart</button>
                            <button class="btn btn-outline-danger btn-sm w-100" onclick="removeFromCompare(${p.id})">Remove</button>
                        </td>
                    `;
                });
                html += '</tr>';

                tbody.innerHTML = html;

            } catch (err) {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Failed to load products.</td></tr>';
            }
        }

        function removeFromCompare(id) {
            let compareList = JSON.parse(localStorage.getItem('compareList')) || [];
            compareList = compareList.filter(item => item != id);
            localStorage.setItem('compareList', JSON.stringify(compareList));
            location.reload();
        }

        function clearAll() {
            localStorage.removeItem('compareList');
            location.reload();
        }

        // Add to Cart Wrapper (Assuming main.js has addToCart but it might need checking)
        // main.js usually has addToCart logic.
    </script>
</body>
</html>